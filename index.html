<!DOCTYPE html>
<html lang="fr">
<head>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KKWCL3F2');</script>
<!-- End Google Tag Manager -->

    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIdos - Dossier Patient Informatisé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* MODIFICATION : Import de la police Parkinsans en plus d'Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Parkinsans:wght@600&display=swap');
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            color: #1f2937;
        }

        /* MODIFICATION : Ajout du style pour le titre EIdos */
        #sidebar h1 {
            font-family: 'Parkinsans', sans-serif;
            font-weight: 600;
        }

        #main-content-wrapper {
            overflow-y: scroll;
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        #main-content-wrapper::-webkit-scrollbar {
            display: none;
        }

        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 16px; 
            border: 1px solid #e5e7eb;
        }
        #patient-header-form .card {
            padding: 0.5rem; 
        }
        .card-header {
            font-size: 1.25rem;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .card-header.header-teal { color: #0f766e; border-bottom-color: #5eead4; border-bottom-width: 2px; } 
        .card-header.header-blue { color: #1e40af; border-bottom-color: #60a5fa; border-bottom-width: 2px; } 
        .card-header.header-rose { color: #be123c; border-bottom-color: #fb7185; border-bottom-width: 2px; }
        .card-header.header-indigo { color: #4338ca; border-bottom-color: #a5b4fc; border-bottom-width: 2px; }
        .card-header.header-green { color: #15803d; border-bottom-color: #86efac; border-bottom-width: 2px; }
        .card-header.header-purple { color: #7e22ce; border-bottom-color: #d8b4fe; border-bottom-width: 2px; }
        .card-header.header-orange { color: #c2410c; border-bottom-color: #fdba74; border-bottom-width: 2px; }

        .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .info-item {
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease-in-out;
            background-color: #fff;
        }
        .info-item:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
        }
        .info-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 4px; }
        .info-value { font-size: 1rem; font-weight: 500; color: #1f2937; }

        .timeline-item { position: relative; padding-left: 2rem; border-left: 2px solid #e5e7eb; }
        .timeline-dot { position: absolute; left: -0.6rem; top: 0.25rem; height: 1rem; width: 1rem; border-radius: 9999px; border: 3px solid white; }
        .timeline-dot.dot-rose { background-color: #f43f5e; }
        .timeline-dot.dot-green { background-color: #22c55e; }
        .diagram th, .diagram td { border: 1px solid #e5e7eb; padding: 0.5rem; vertical-align: middle; }
        .diagram input[type="checkbox"] { height: 1.1rem; width: 1.1rem; accent-color: #3b82f6; }
        .diagram thead { font-size: 0.8rem; background-color: #f9fafb; color: #374151; }

        .diagram input[type="text"], .diagram input[type="number"] {
            width: 100%; border: none; text-align: center; padding: 4px; background-color: transparent;
            transition: background-color 0.2s; color: #1f2937; font-size: 0.75rem;
        }
        .diagram input[type="text"]:focus, .diagram input[type="number"]:focus {
            outline: 2px solid #3b82f6; background-color: #eff6ff; border-radius: 4px;
        }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield;
        }
        .continuous-surveillance { background-image: linear-gradient(45deg, #fef3c7 25%, transparent 25%, transparent 50%, #fef3c7 50%, #fef3c7 75%, transparent 75%, transparent 100%); background-size: 20px 20px; }

        .styled-input {
            background-color: #f9fafb; border: 1px solid #d1d5db; transition: all 0.2s ease-in-out;
            padding: 0.5rem 0.75rem; border-radius: 0.375rem;
            width: 100%;
        }
        .styled-input:focus {
            outline: 2px solid #3b82f6; outline-offset: -1px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); border-color: #3b82f6;
        }
        textarea.info-value {
            resize: none;
            overflow: hidden;
        }

        .styled-input:disabled, textarea.info-value:disabled, input.info-value:disabled {
            background-color: transparent;
            border-color: transparent;
            cursor: default;
            color: #1f2937;
        }
        .info-item > textarea.info-value,
        .info-item > input.info-value,
        .info-item > textarea.info-value:disabled,
        .info-item > input.info-value:disabled {
           background-color: transparent;
           border-color: transparent;
           padding: 0;
           border-radius: 0;
           box-shadow: none;
           width: 100%;
        }
        .info-item > textarea.info-value:focus,
        .info-item > input.info-value:focus {
            outline: none;
            box-shadow: none;
            border-color: transparent;
        }
        .info-item > input[type="date"].info-value::-webkit-calendar-picker-indicator {
            filter: invert(0.35);
        }
        .info-item > input[type="date"].info-value:disabled::-webkit-calendar-picker-indicator {
            display: none;
        }
        .preserve-whitespace {
            white-space: pre-wrap;
        }

        #custom-confirm-modal #custom-confirm-box {
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        #sidebar {
            transition: width 0.3s ease;
        }
        #patient-list li button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            text-align: left;
        }
        #patient-list li button:hover {
            background-color: #f3f4f6; 
        }
        #patient-list li button.active {
            background-color: #0d9488; 
            color: white;
            font-weight: 600;
        }
        #patient-list li button.active .patient-room {
            color: #ccfbf1; 
        }
        #patient-list li button .patient-icon {
            margin-right: 0.75rem;
            width: 1.25rem;
            text-align: center;
        }
        .patient-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .patient-room {
            font-size: 0.8rem;
            color: #6b7280; 
            margin-left: 0.5rem;
        }

        .iv-bar-container {
            position: relative;
            height: 38px;
            padding: 0 !important;
            cursor: crosshair;
        }
        .iv-bar {
            position: absolute;
            top: 55%;
            transform: translateY(-50%);
            height: 50%;
            background-color: #60a5fa;
            border: 1px solid #2563eb;
            border-radius: 4px;
            cursor: move;
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            right: -2px;
            top: -2px;
            width: 10px;
            height: calc(100% + 4px);
            cursor: ew-resize;
            z-index: 11;
        }
        body.is-drawing-iv, body.is-resizing-iv, body.is-moving-iv {
            cursor: ew-resize !important;
            user-select: none;
        }
        .iv-bar-container .iv-time-label {
            position: absolute;
            top: 2px;
            font-family: monospace;
            font-size: 10px;
            background: rgba(229, 231, 235, 0.8);
            padding: 1px 3px;
            border-radius: 3px;
            color: #374151;
            pointer-events: none;
            white-space: nowrap;
            z-index: 12;
        }
        .iv-time-label.end {
             transform: translateX(-100%);
        }

        #tutorial-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
            z-index: 9990;
            transition: opacity 0.3s ease;
        }
        #tutorial-step-box {
            position: absolute;
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            width: 100%;
            max-width: 350px;
            transition: top 0.3s ease, left 0.3s ease, opacity 0.3s ease;
        }
        .tutorial-highlight {
            position: relative;
            z-index: 9995 !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7);
            border-radius: 0.5rem;
        }
        .tutorial-highlight > * {
             position: relative;
             z-index: 9996;
        }
        #header-buttons .tutorial-highlight {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #header-buttons .tutorial-highlight i {
             color: white !important;
             z-index: 9997;
        }
        #sidebar .tutorial-highlight {
            background-color: white;
        }

    </style>
</head>
<body class="flex h-screen bg-gray-100">
    <aside id="sidebar" class="w-64 bg-white shadow-xl flex flex-col flex-shrink-0 m-4 rounded-2xl h-[calc(100vh-2rem)] transition-all duration-300 ease-in-out">
        <div class="p-4 bg-gradient-to-br from-teal-500 to-cyan-600 text-white rounded-t-2xl">
            <div class="flex items-center space-x-3">
                <svg class="h-10 w-10 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12" />
                </svg>
                <div>
                    <!-- Le H1 ici utilisera la nouvelle police "Parkinsans" -->
                    <h1 class="text-2xl font-bold">EIdos</h1>
                    <p class="text-xs text-cyan-100">Simulation de Dossier Patient</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto">
            <ul id="patient-list" class="p-2">
                </ul>
        </nav>
        <div class="p-2 border-t border-gray-100">
            <a href="https://fr.linkedin.com/in/lucas-s%C3%A9raudie-1858ba14b" target="_blank" rel="noopener noreferrer" class="block w-full text-left text-sm text-gray-600 hover:bg-gray-100 p-2 rounded-md transition-colors mb-1">
                <i class="fab fa-linkedin w-6 text-center mr-1"></i>
                Me contacter
            </a>
            <button onclick="startTutorial()" class="w-full text-left text-sm text-blue-600 hover:bg-blue-100 p-2 rounded-md transition-colors mb-1">
                <i class="fas fa-question-circle w-6 text-center mr-1"></i>
                Aide / Tuto
            </button>
            <button onclick="clearAllData()" class="w-full text-left text-sm text-red-600 hover:bg-red-100 p-2 rounded-md transition-colors">
                <i class="fas fa-exclamation-triangle w-6 text-center mr-1"></i>
                Vider tous les dossiers
            </button>
        </div>
    </aside>
    <div class="flex-1 flex flex-col overflow-hidden m-4 h-[calc(100vh-2rem)]">

        <div class="p-0 md:p-0 lg:p-0 pb-0">
            <div class="max-w-screen-xl mx-auto">
                <header id="main-header" class="mb-4 p-4 rounded-xl bg-gradient-to-r from-cyan-600 to-teal-400 text-white shadow-lg flex justify-between items-center">
                    <h1 class="text-xl lg:text-2xl font-bold">Service de soins de l'IFSI</h1>
                    <div id="header-buttons" class="flex items-center space-x-2">
                        <button type="button" onclick="exportCurrentPatientData()" title="Exporter le dossier actuel" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                            <i class="fas fa-file-export text-white"></i>
                        </button>
                        <button type="button" onclick="document.getElementById('import-file').click()" title="Importer dans ce dossier" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                            <i class="fas fa-file-import text-white"></i>
                        </button>
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importCurrentPatientData(event)">
                        <button type="button" onclick="clearCurrentPatientData()" title="Effacer le dossier actuel" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                            <i class="fas fa-trash text-white"></i>
                        </button>
                        <span class="font-light text-sm mr-4">EIdos - créé par L. Séraudie - 2025</span>
                        <button type="button" onclick="toggleFullscreen()" title="Plein écran" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                            <i id="fullscreen-icon" class="fas fa-expand text-white"></i>
                        </button>
                    </div>
                </header>

                <header id="patient-header-form" class="mb-4">
                    <div class="card p-2">
                        <div class="grid grid-cols-12 gap-x-2 gap-y-3 items-stretch">
                            <div class="info-item col-span-12 sm:col-span-6 md:col-span-2"><span class="info-label">Nom d'usage</span><input type="text" id="patient-nom-usage" class="info-value text-lg font-bold" placeholder="NOM Usage"></div>
                            <div class="info-item col-span-12 sm:col-span-6 md:col-span-2"><span class="info-label">Prénom</span><input type="text" id="patient-prenom" class="info-value text-lg font-bold" placeholder="Prénom"></div>
                            <div class="info-item col-span-12 sm:col-span-12 md:col-span-3">
                                <span class="info-label">Date de naissance</span>
                                <div class="flex items-center gap-2"><input type="date" id="patient-dob" class="info-value text-gray-500 flex-grow" style="flex-basis: 150px;"><span id="patient-age" class="text-sm text-gray-600 font-medium whitespace-nowrap"></span></div>
                            </div>

                            <div class="info-item col-span-12 sm:col-span-6 md:col-span-2"><span class="info-label">Motif d'hospitalisation</span><input type="text" id="patient-motif" class="info-value"></div>

                            <div class="info-item col-span-12 sm:col-span-6 md:col-span-2">
                                <span class="info-label">Date d'entrée / Jour</span>
                                <div class="flex items-center gap-2">
                                    <input type="date" id="patient-entry-date" class="info-value">
                                    <span id="patient-jour-hosp" class="info-value font-bold text-lg text-teal-700">J-</span>
                                </div>
                            </div>
                            <div class="col-span-12 sm:col-span-12 md:col-span-1 flex items-end justify-end">
                                <button id="lock-header-btn" type="button" onclick="toggleLock('patient-header-form', 'lock-header-btn')" class="w-full h-full inline-flex items-center justify-center py-2 px-3 border shadow-sm text-sm font-medium rounded-md transition-colors bg-transparent hover:text-white border-teal-600 text-teal-700 hover:bg-teal-600">
                                    <i class="fas fa-check mr-2"></i> Valider
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <div id="tabs-nav-container" class="card p-2">
                       <nav class="flex flex-wrap w-full gap-2" aria-label="Tabs">
                            <button type="button" onclick="changeTab(event, 'administratif')" data-color="teal"><i class="fas fa-user-circle mr-2"></i>Administratif</button>
                            <button type="button" onclick="changeTab(event, 'mode-de-vie')" data-color="blue"><i class="fas fa-home mr-2"></i>Vie & ATCD</button>
                            <button type="button" onclick="changeTab(event, 'observations')" data-color="rose"><i class="fas fa-notes-medical mr-2"></i>Observations Médicales</button>
                            <button type="button" onclick="changeTab(event, 'prescriptions')" data-color="indigo"><i class="fas fa-pills mr-2"></i>Prescriptions</button>
                            <button type="button" onclick="changeTab(event, 'transmissions')" data-color="green"><i class="fas fa-exchange-alt mr-2"></i>Transmissions</button>
                            <button type="button" onclick="changeTab(event, 'pancarte')" data-color="orange"><i class="fas fa-chart-line mr-2"></i>Pancarte</button>
                            <button type="button" onclick="changeTab(event, 'diagramme')" data-color="rose"><i class="fas fa-calendar-alt mr-2"></i>Diagramme Soins</button>
                            <button type="button" onclick="changeTab(event, 'biologie')" data-color="purple"><i class="fas fa-vial mr-2"></i>Résultats Biologiques</button>
                       </nav>
                </div>
            </div>
        </div>
        <div id="main-content-wrapper" class="flex-1 overflow-x-hidden overflow-y-auto px-4 md:px-6 lg:px-8">
            <div class="max-w-screen-xl mx-auto py-4 md:py-6 lg:py-8 pt-0">
                <main>
                    <div id="tab-content">
                        <div id="administratif" class="content-section active">
                            <div class="card p-6">
                                <h2 class="card-header">Dossier Administratif</h2>
                                <div class="mt-6">
                                    <h3 class="text-lg font-medium text-gray-800 mb-4 pb-2 border-b">Identité du patient</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <div class="info-item"><span class="info-label">Nom d'usage</span><textarea id="admin-nom-usage" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Prénom</span><textarea id="admin-prenom" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item">
                                            <span class="info-label">Date de Naissance</span>
                                            <div class="flex items-center gap-2">
                                                <input type="date" id="admin-dob" class="info-value flex-grow" style="flex-basis: 150px;">
                                                <span id="admin-age" class="text-sm text-gray-600 font-medium whitespace-nowrap"></span>
                                            </div>
                                        </div>
                                        <div class="info-item"><span class="info-label">Sexe</span><textarea id="admin-sexe" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item col-span-full lg:col-span-2"><span class="info-label">Adresse</span><textarea id="admin-adresse" class="info-value" oninput="autoResize(this)"></textarea></div>
                                    </div>
                                </div>
                                <div class="mt-8">
                                     <h3 class="text-lg font-medium text-gray-800 mb-4 pb-2 border-b">Contacts</h3>
                                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="info-item"><span class="info-label">Personne à contacter</span><textarea id="admin-contact" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Téléphone</span><textarea id="admin-telephone" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Médecin traitant</span><textarea id="admin-medecin" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Personne de confiance</span><textarea id="admin-pers-confiance" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Téléphone P. de confiance</span><textarea id="admin-pers-confiance-tel" class="info-value" oninput="autoResize(this)"></textarea></div>
                                    </div>
                                </div>
                                 <div class="mt-8">
                                     <h3 class="text-lg font-medium text-gray-800 mb-4 pb-2 border-b">Couverture Sociale</h3>
                                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="info-item"><span class="info-label">N° de Sécurité Sociale</span><textarea id="admin-secu" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Mutuelle</span><textarea id="admin-mutuelle" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">N° Adhérent Mutuelle</span><textarea id="admin-mutuelle-num" class="info-value" oninput="autoResize(this)"></textarea></div>
                                     </div>
                                 </div>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button id="lock-admin-btn" type="button" onclick="toggleLock('administratif', 'lock-admin-btn')" class="inline-flex items-center justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md transition-colors bg-transparent hover:text-white border-teal-600 text-teal-700 hover:bg-teal-600">
                                    <i class="fas fa-check mr-2"></i>Valider les données
                                </button>
                            </div>
                        </div>
                        <div id="mode-de-vie" class="content-section">
                            <div class="card p-6">
                                <h2 class="card-header">Mode de Vie & Antécédents</h2>
                                <div class="mt-6">
                                    <h3 class="text-lg font-medium text-gray-800 mb-4 pb-2 border-b">Mode de vie</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="info-item"><span class="info-label">Situation familiale/professionnelle</span><textarea id="vie-situation" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Conditions de logement (Habitat)</span><textarea id="vie-habitat" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Habitudes (Alcool, Tabac, etc.)</span><textarea id="vie-habitudes" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Poids (kg)</span><textarea id="vie-poids" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Taille (cm)</span><textarea id="vie-taille" class="info-value" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Régime alimentaire</span><textarea id="vie-regime" class="info-value" oninput="autoResize(this)"></textarea></div>
                                    </div>
                                </div>
                                <div class="mt-8">
                                    <h3 class="text-lg font-medium text-gray-800 mb-4 pb-2 border-b">Antécédents (ATCD)</h3>
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div class="info-item"><span class="info-label">Médicaux</span><textarea id="atcd-medicaux" class="info-value" rows="6" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Chirurgicaux</span><textarea id="atcd-chirurgicaux" class="info-value" rows="6" oninput="autoResize(this)"></textarea></div>
                                        <div class="info-item"><span class="info-label">Allergies</span><textarea id="atcd-allergies" class="info-value" rows="6" oninput="autoResize(this)"></textarea></div>
                                    </div>
                                </div>
                            </div>
                             <div class="flex justify-end mt-4">
                                <button id="lock-vie-btn" type="button" onclick="toggleLock('mode-de-vie', 'lock-vie-btn')" class="inline-flex items-center justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md transition-colors bg-transparent hover:text-white border-blue-600 text-blue-700 hover:bg-blue-600">
                                    <i class="fas fa-check mr-2"></i>Valider les données
                                </button>
                            </div>
                        </div>
                        <div id="observations" class="content-section">
                            <div class="card p-6"><h2 class="card-header">Suivi Médical</h2><div id="observations-list" class="space-y-8 mt-4"></div></div>
                            <div class="card p-6">
                                <h2 class="card-header">Ajouter une observation médicale</h2>
                                <form id="new-observation-form" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="md:col-span-2"><label for="new-observation-author" class="block text-sm font-medium text-gray-700">Auteur (ex: Dr. REED)</label><input type="text" id="new-observation-author" class="styled-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></div>
                                        <div><label for="new-observation-date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="new-observation-date" class="styled-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></div>
                                    </div>
                                    <div><label for="new-observation-text" class="block text-sm font-medium text-gray-700">Observation</label><textarea id="new-observation-text" rows="4" class="styled-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></textarea></div>
                                    <div class="flex justify-end"><button type="button" onclick="addObservation()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-rose-600 hover:bg-rose-700">Ajouter</button></div>
                                </form>
                            </div>
                        </div>
                        <div id="prescriptions" class="content-section">
                            <div class="card p-6">
                                 <h2 class="card-header">Prescriptions Médicales</h2>
                                 <div class="overflow-x-auto mt-4">
                                     <table class="w-full border-collapse text-sm diagram" id="prescription-table">
                                         <thead id="prescription-thead" class="bg-gray-100 text-gray-600">
                                         </thead>
                                         <tbody class="text-center" id="prescription-tbody"></tbody>
                                     </table>
                                 </div>
                            </div>
                             <div class="card p-6">
                                 <h2 class="card-header">Ajouter une prescription</h2>
                                 <form id="new-prescription-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                     <div>
                                         <label for="med-name" class="block text-sm font-medium text-gray-700">Médicament / Soin</label>
                                         <input type="text" id="med-name" class="styled-input mt-1">
                                     </div>
                                     <div>
                                         <label for="med-posologie" class="block text-sm font-medium text-gray-700">Posologie</label>
                                         <input type="text" id="med-posologie" class="styled-input mt-1">
                                     </div>
                                     <div>
                                         <label for="med-voie" class="block text-sm font-medium text-gray-700">Voie</label>
                                         <input type="text" id="med-voie" class="styled-input mt-1">
                                     </div>
                                     <div>
                                         <label for="med-start-date" class="block text-sm font-medium text-gray-700">Date de début</label>
                                         <input type="date" id="med-start-date" class="styled-input mt-1">
                                     </div>
                                     <div class="md:col-start-4 flex justify-end">
                                         <button type="button" onclick="addPrescription()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Ajouter</button>
                                     </div>
                                 </form>
                             </div>
                        </div>
                        <div id="transmissions" class="content-section">
                            <div class="card p-6"><h2 class="card-header">Transmissions Soignantes</h2><div id="transmissions-list-ide" class="space-y-8 mt-4"></div></div>
                            <div class="card p-6">
                                <h2 class="card-header">Ajouter une transmission</h2>
                                <form id="new-transmission-form-2" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="md:col-span-2"><label for="new-transmission-author-2" class="block text-sm font-medium text-gray-700">Auteur (ex: IDE, AS)</label><input type="text" id="new-transmission-author-2" class="styled-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></div>
                                        <div><label for="new-transmission-date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="new-transmission-date" class="styled-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></div>
                                    </div>
                                    <div><label for="new-transmission-text-2" class="block text-sm font-medium text-gray-700">Transmission Ciblée</label><textarea id="new-transmission-text-2" rows="4" class="styled-input mt-1 block w-full rounded-md shadow-sm sm:text-sm" placeholder="Cible :&#10;Données :&#10;Actions :&#10;Résultats :"></textarea></div>
                                    <div class="flex justify-end"><button type="button" onclick="addTransmission()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Ajouter</button></div>
                                </form>
                            </div>
                        </div>
                        <div id="biologie" class="content-section">
                            <div class="card p-6">
                                <h2 class="card-header">Suivi Biologique</h2>
                                <div class="overflow-x-auto mt-4">
                                    <table class="w-full border-collapse text-sm diagram" id="bio-table">
                                        <thead id="bio-thead" class="bg-gray-100 text-gray-600">
                                        </thead>
                                        <tbody id="bio-tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="pancarte" class="content-section">
                            <div class="card p-6">
                                <h2 class="card-header">Graphique des Constantes</h2>
                                <div class="relative h-96 w-full"><canvas id="pancarteChart"></canvas></div>
                            </div>
                            <div class="card p-6">
                                <h2 class="card-header">Tableau de Surveillance (Pancarte)</h2>
                                <div class="overflow-x-auto mt-4">
                                    <table class="w-full border-collapse text-sm text-center diagram" id="pancarte-table">
                                        <thead id="pancarte-thead" class="bg-gray-100 text-gray-600">
                                        </thead>
                                        <tbody id="pancarte-tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="diagramme" class="content-section">
                             <div class="card p-6">
                                <h2 class="card-header">Diagramme de Soins</h2>
                                <div class="overflow-x-auto"><table class="w-full table-auto text-sm text-center diagram" id="care-diagram-table">
                                    <thead id="care-diagram-thead" class="font-semibold bg-gray-100">
                                    </thead>
                                    <tbody id="care-diagram-tbody">
                                         <tr class="font-bold bg-blue-50 text-left"><td class="p-2" colspan="34">Hygiène & Confort</td></tr>
                                         <tr><td class="text-left p-2">Toilette au lit / lavabo</td><script>for(let i=0; i<11; i++) document.write(`<td class="border-l"><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>`)</script></tr>
                                         <tr><td class="text-left p-2">Prévention d'escarres</td><script>for(let i=0; i<11; i++) document.write(`<td class="border-l"><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>`)</script></tr>
                                         <tr class="font-bold bg-blue-50 text-left"><td class="p-2" colspan="34">Mobilisation</td></tr>
                                         <tr><td class="text-left p-2">Bas de contention</td><script>for(let i=0; i<11; i++) document.write(`<td class="border-l"><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>`)</script></tr>
                                         <tr><td class="text-left p-2">Séance de kinésithérapie</td><script>for(let i=0; i<11; i++) document.write(`<td class="border-l"><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>`)</script></tr>
                                         <tr class="font-bold bg-blue-50 text-left"><td class="p-2" colspan="34">Autres</td></tr>
                                    </tbody>
                                </table></div>
                             </div>
                             <div class="card p-6">
                                <h2 class="card-header">Ajouter un soin</h2>
                                <form id="new-care-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                    <div>
                                       <label for="care-name" class="block text-sm font-medium text-gray-700">Soin / Surveillance</label>
                                       <input type="text" id="care-name" class="styled-input mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                   </div>
                                    <div class="flex justify-start md:col-start-4">
                                       <button type="button" onclick="addCareDiagramRow()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-rose-600 hover:bg-rose-700">Ajouter</button>
                                   </div>
                                </form>
                             </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        </div>
    
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md m-4 transform transition-all scale-95 opacity-0" id="custom-confirm-box">
            <h3 class="text-lg font-bold text-gray-800" id="custom-confirm-title">Confirmation requise</h3>
            <p class="mt-2 text-sm text-gray-600" id="custom-confirm-message">Êtes-vous sûr de vouloir effectuer cette action ?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="custom-confirm-cancel" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">Annuler</button>
                <button id="custom-confirm-ok" type="button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Confirmer</button>
            </div>
        </div>
    </div>

    <div id="tutorial-overlay" class="hidden" onclick="endTutorial(true)">
        <div id="tutorial-step-box" onclick="event.stopPropagation()">
            <p id="tutorial-text" class="text-gray-700 text-sm mb-4">Ceci est une étape du tutoriel.</p>
            <div class="flex justify-between items-center">
                <button id="tutorial-skip-btn" onclick="endTutorial(true)" class="text-xs text-gray-500 hover:text-gray-800 transition-colors">Passer</button>
                <button id="tutorial-next-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">Suivant</button>
            </div>
        </div>
    </div>


    <script>
        let pancarteChartInstance;
        const patients = Array.from({ length: 10 }, (_, i) => ({
            id: `chambre_${101 + i}`,
            room: `${101 + i}`
        }));
        let activePatientId = localStorage.getItem('activePatientId') || patients[0].id;

        let ivInteraction = {
            active: false,
            mode: null, 
            targetBar: null,
            targetCell: null,
            startX: 0,
            startLeft: 0,
            startWidth: 0,
        };

        const nfsData = { "Hématies (T/L)": "4.5-5.5", "Hémoglobine (g/dL)": "13-17", "Hématocrite (%)": "40-52", "VGM (fL)": "80-100", "Leucocytes (G/L)": "4-10", "Plaquettes (G/L)": "150-400" };
        const ionoData = { "Sodium (mmol/L)": "136-145", "Potassium (mmol/L)": "3.5-5.1", "Chlore (mmol/L)": "98-107", "Bicarbonates (mmol/L)": "22-29", "Urée (mmol/L)": "2.8-7.2", "Créatinine (µmol/L)": "62-106" };
        const hepatiqueData = { "ASAT (UI/L)": "< 40", "ALAT (UI/L)": "< 41", "Gamma-GT (UI/L)": "11-50", "PAL (UI/L)": "40-129", "Bilirubine totale (µmol/L)": "5-21" };
        const lipidiqueData = { "Cholestérol total (g/L)": "< 2.0", "Triglycérides (g/L)": "< 1.5", "HDL Cholestérol (g/L)": "> 0.4", "LDL Cholestérol (g/L)": "< 1.6" };
        const gdsData = { "pH": "7.35-7.45", "PaCO2 (mmHg)": "35-45", "PaO2 (mmHg)": "80-100", "HCO3- (mmol/L)": "22-26", "SaO2 (%)": "> 95" };
        // MODIFICATION : Ajout des données pour la CRP
        const inflammationData = { "CRP (mg/L)": "< 5" };
        const pancarteData = {
            'Pouls (/min)': [], 'Tension (mmHg)': [], 'Température (°C)': [], 'SpO2 (%)': [], 'Douleur (EVA /10)': []
        };

        function getSaveKey(patientId) {
            return `dossierPatientData_${patientId}`;
        }

        // MODIFICATION : `saveData` pour générer un JSON structuré
        function saveData(patientId) {
            if (!patientId) return;
            const SAVE_KEY = getSaveKey(patientId);
            const state = {};

            // 1. Sauvegarder tous les champs <input> et <textarea> simples avec un ID
            document.querySelectorAll('input[id], textarea[id]').forEach(el => {
                const id = el.id;
                if (el.type === 'checkbox' || el.type === 'radio') {
                    state[id] = el.checked;
                } else {
                    state[id] = el.value;
                }
            });

            // 2. Sauvegarder le contenu HTML des listes dynamiques (Observations, Transmissions)
            const dynamicContentIds = ['observations-list', 'transmissions-list-ide', 'care-diagram-tbody'];
            dynamicContentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) state[id + '_html'] = el.innerHTML;
            });

            // 3. NOUVEAU : Sauvegarder les données de Biologie dans un objet structuré
            const bioData = {
                dates: [],
                analyses: {}
            };
            document.querySelectorAll('#bio-table thead input[type="text"]').forEach(input => {
                bioData.dates.push(input.value);
            });
            document.querySelectorAll('#bio-table tbody tr').forEach(row => {
                // S'assurer que c'est une ligne d'analyse (contient une cellule de titre)
                if (row.cells.length > 1 && row.cells[0].classList.contains('font-semibold')) { 
                    const analyseName = row.cells[0].textContent.trim();
                    if (analyseName) {
                        bioData.analyses[analyseName] = [];
                        row.querySelectorAll('input[type="text"]').forEach(input => {
                            bioData.analyses[analyseName].push(input.value);
                        });
                    }
                }
            });
            state.biologie = bioData;

            // 4. NOUVEAU : Sauvegarder les données de Pancarte dans un objet structuré
            const pancarteData = {};
            document.querySelectorAll('#pancarte-table tbody tr').forEach(row => {
                const paramName = row.cells[0].textContent.trim();
                if (paramName) {
                    pancarteData[paramName] = [];
                    row.querySelectorAll('input').forEach(input => {
                        pancarteData[paramName].push(input.value);
                    });
                }
            });
            state.pancarte = pancarteData;

            // 5. Sauvegarder les Prescriptions (déjà structurées)
            state.prescriptions = [];
            document.querySelectorAll('#prescription-tbody tr').forEach(row => {
                const isIV = row.dataset.type === 'iv';
                const prescriptionData = {
                    name: row.cells[0].querySelector('span').textContent,
                    posologie: row.cells[1].textContent,
                    voie: row.cells[2].textContent,
                    startDate: row.cells[3].textContent,
                    type: isIV ? 'iv' : 'checkbox'
                };

                if (isIV) {
                    const barsNodeList = row.querySelectorAll('.iv-bar');
                    prescriptionData.bars = [];
                    barsNodeList.forEach(bar => {
                        prescriptionData.bars.push({
                            left: bar.style.left,
                            width: bar.style.width,
                            title: bar.title
                        });
                    });
                } else {
                    prescriptionData.checkboxes = Array.from(row.querySelectorAll('input[type="checkbox"]')).map(cb => cb.checked);
                }
                state.prescriptions.push(prescriptionData);
            });

            // 6. Sauvegarder les cases à cocher du diagramme de soins
            state.careDiagramCheckboxes = Array.from(document.querySelectorAll('#care-diagram-tbody input[type="checkbox"]')).map(cb => cb.checked);
            
            // 7. Sauvegarder l'état des boutons de verrouillage
            state.lockButtonStates = {};
            document.querySelectorAll('button[id^="lock-"]').forEach(btn => {
                state.lockButtonStates[btn.id] = btn.innerHTML.includes('fa-lock');
            });

            // 8. Sauvegarder le nom du patient pour la barre latérale
            const nomUsage = document.getElementById('patient-nom-usage').value.trim();
            const prenom = document.getElementById('patient-prenom').value.trim();
            const patientName = `${nomUsage} ${prenom}`.trim();
            state['sidebar_patient_name'] = patientName;
            
            // 9. Sauvegarder dans le localStorage
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
            
            // 10. Mettre à jour la barre latérale
            const sidebarEntry = document.querySelector(`#patient-list button[data-patient-id="${patientId}"] .patient-name`);
            if (sidebarEntry) {
                sidebarEntry.textContent = patientName || `Chambre ${patientId.split('_')[1]}`;
            }
        }
        
        // MODIFICATION : `loadData` pour lire le JSON structuré
        function loadData(patientId) {
            if (!patientId) return;
            const SAVE_KEY = getSaveKey(patientId);
            const savedState = localStorage.getItem(SAVE_KEY);

            if (!savedState || savedState === '{}') {
                resetForm();
            } else {
                const state = JSON.parse(savedState);
                
                // 1. Charger tous les champs <input> et <textarea> simples
                Object.keys(state).forEach(id => {
                    // Ne pas essayer de charger les objets structurés comme des champs simples
                    if (id === 'biologie' || id === 'pancarte' || id === 'prescriptions' || id === 'lockButtonStates' || id === 'careDiagramCheckboxes' || id.endsWith('_html')) return;
                    
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.type === 'checkbox' || el.type === 'radio') {
                            el.checked = state[id];
                        } else {
                            el.value = state[id];
                        }
                    }
                });

                // 2. Charger le contenu HTML dynamique (Observations, Transmissions)
                const dynamicContentIds = ['observations-list', 'transmissions-list-ide', 'care-diagram-tbody'];
                 dynamicContentIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && state[id + '_html']) {
                        el.innerHTML = state[id + '_html'];
                    }
                });

                // 3. Charger les Prescriptions
                if (state.prescriptions) {
                    const tbody = document.getElementById('prescription-tbody');
                    tbody.innerHTML = '';
                    state.prescriptions.forEach(pData => {
                        addPrescription(pData, true);
                    });
                }
                
                // 4. Charger les cases à cocher du diagramme de soins
                if (state.careDiagramCheckboxes) {
                    document.querySelectorAll('#care-diagram-tbody input[type="checkbox"]').forEach((cb, index) => {
                        cb.checked = state.careDiagramCheckboxes[index] || false;
                    });
                }

                // 5. NOUVEAU : Charger les données de Biologie depuis l'objet structuré
                if (state.biologie) {
                    document.querySelectorAll('#bio-table thead input[type="text"]').forEach((input, index) => {
                        if (state.biologie.dates && state.biologie.dates[index]) {
                            input.value = state.biologie.dates[index];
                        }
                    });
                    document.querySelectorAll('#bio-table tbody tr').forEach(row => {
                        if (row.cells.length > 1 && row.cells[0].classList.contains('font-semibold')) {
                            const analyseName = row.cells[0].textContent.trim();
                            if (analyseName && state.biologie.analyses && state.biologie.analyses[analyseName]) {
                                row.querySelectorAll('input[type="text"]').forEach((input, index) => {
                                    input.value = state.biologie.analyses[analyseName][index] || '';
                                });
                            }
                        }
                    });
                }

                // 6. NOUVEAU : Charger les données de Pancarte depuis l'objet structuré
                if (state.pancarte) {
                    document.querySelectorAll('#pancarte-table tbody tr').forEach(row => {
                        const paramName = row.cells[0].textContent.trim();
                        if (paramName && state.pancarte && state.pancarte[paramName]) {
                            row.querySelectorAll('input').forEach((input, index) => {
                                input.value = state.pancarte[paramName][index] || '';
                            });
                        }
                    });
                }
                
                // 7. Mettre à jour les dates dynamiques (J0, J1...)
                const entryDateValue = document.getElementById('patient-entry-date').value;
                if (entryDateValue) {
                    const entryDate = new Date(entryDateValue);
                    if (!isNaN(entryDate.getTime())) {
                        updateDynamicDates(entryDate);
                    }
                }
                
                // 8. Charger l'état des boutons de verrouillage
                if (state.lockButtonStates) {
                    Object.keys(state.lockButtonStates).forEach(buttonId => {
                        if (state.lockButtonStates[buttonId]) {
                            const button = document.getElementById(buttonId);
                            if (button && button.innerHTML.includes('fa-check')) {
                                let containerId;
                                if (buttonId === 'lock-header-btn') containerId = 'patient-header-form';
                                if (buttonId === 'lock-admin-btn') containerId = 'administratif';
                                if (buttonId === 'lock-vie-btn') containerId = 'mode-de-vie';
                                if (containerId) toggleLock(containerId, buttonId);
                            }
                        }
                    });
                }
            }
            
            // Mettre à jour le nom de la chambre (non sauvegardé dans le JSON)
            const roomDisplay = document.querySelector(`#patient-list button[data-patient-id="${patientId}"] .patient-room`);
            if (roomDisplay) {
                const patientRoomEl = document.getElementById('patient-room');
                if (patientRoomEl) patientRoomEl.value = roomDisplay.textContent;
            }
            
            updateAgeDisplay();
            updateJourHosp(); 
        }

        function clearCurrentPatientData() {
            const message = `Êtes-vous sûr de vouloir effacer le dossier du patient dans la chambre ${activePatientId.split('_')[1]} ? Cette action est irréversible.`;
            showDeleteConfirmation(message, () => {
                localStorage.removeItem(getSaveKey(activePatientId));
                switchPatient(activePatientId, true); 
            });
        }
        function clearAllData() {
            const message = "ATTENTION : Vous êtes sur le point de supprimer TOUS les dossiers de tous les patients. Cette action est irréversible. Continuer ?";
            showDeleteConfirmation(message, () => {
                localStorage.clear();
                location.reload();
            });
        }
        function exportCurrentPatientData() {
            saveData(activePatientId);
            const SAVE_KEY = getSaveKey(activePatientId);
            const dataStr = localStorage.getItem(SAVE_KEY);
            if (!dataStr || dataStr === '{}') return;
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const patientName = (document.getElementById('patient-nom-usage').value.trim() || activePatientId).replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `dossier_${patientName}.json`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        }
        function importCurrentPatientData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            reader.onload = e => {
                const content = e.target.result;
                try {
                    if (!content || typeof content !== 'string' || content.trim().length === 0) {
                         throw new Error("Le contenu du fichier est vide ou invalide.");
                    }
                    const jsonData = JSON.parse(content); 
                    if (typeof jsonData !== 'object' || jsonData === null) {
                         throw new Error("Le fichier JSON ne contient pas un objet valide.");
                    }
                    const SAVE_KEY = getSaveKey(activePatientId);
                    localStorage.setItem(SAVE_KEY, content);
                    location.reload();
                } catch (error) {
                    showCustomAlert("Erreur d'importation", `Le fichier n'est pas un JSON valide ou est corrompu. Erreur: ${error.message}`);
                }
            };
            reader.onerror = (e) => {
                showCustomAlert("Erreur de lecture", "Impossible de lire le fichier sélectionné.");
            };

            reader.readAsText(file);
            event.target.value = '';
        }
        function initSidebar() {
            const list = document.getElementById('patient-list');
            let listHTML = '';
            patients.forEach(patient => {
                const savedState = JSON.parse(localStorage.getItem(getSaveKey(patient.id)) || '{}');
                const patientName = savedState.sidebar_patient_name || `Chambre ${patient.room}`;
                listHTML += `
                    <li class="mb-1">
                        <button type="button" data-patient-id="${patient.id}" onclick="switchPatient('${patient.id}')">
                            <span class="patient-icon"><i class="fas fa-bed"></i></span>
                            <span class="patient-name">${patientName}</span>
                            <span class="patient-room">${patient.room}</span>
                        </button>
                    </li>`;
            });
            list.innerHTML = listHTML;
        }
        function updateSidebarActiveState(patientId) {
            document.querySelectorAll('#patient-list button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.patientId === patientId) {
                    btn.classList.add('active');
                }
            });
        }
        function resetForm() {
            document.querySelectorAll('#patient-header-form input, #patient-header-form textarea, main input, main textarea').forEach(el => {
                if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                else if (el.type !== 'file') el.value = '';
            });
            ['observations-list', 'transmissions-list-ide', 'prescription-tbody', 'care-diagram-tbody'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });
            document.querySelectorAll('button[id^="lock-"]').forEach(btn => {
                if (btn.innerHTML.includes('fa-lock')) btn.click();
            });
            if (pancarteChartInstance) pancarteChartInstance.destroy();
        }
        function switchPatient(newPatientId, skipSave = false) {
            if (activePatientId !== newPatientId && !skipSave) {
                saveData(activePatientId);
            }
            activePatientId = newPatientId;
            localStorage.setItem('activePatientId', newPatientId);
            resetForm();
            loadData(newPatientId);
            updateSidebarActiveState(newPatientId);
            setTimeout(() => {
                document.querySelectorAll('textarea.info-value').forEach(autoResize);
            }, 0);
            updatePancarteChart();
            const mainContent = document.getElementById('main-content-wrapper');
            mainContent.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function generateBioRows(title, data) {
            let html = `<tr class="font-bold bg-purple-50 text-left"><td class="p-2" colspan="8">${title}</td></tr>`;
            for (const [key, value] of Object.entries(data)) {
                html += `<tr><td class="p-2 text-left font-semibold">${key}</td><td class="p-2 text-left text-xs">${value}</td>`;
                for (let i = 0; i < 6; i++) {
                    html += '<td class="p-0"><input type="text"></td>';
                }
                html += '</tr>';
            }
            return html;
        }

        function initializeDynamicTables() {
            let html = '';

            const prescriptionThead = document.getElementById('prescription-thead');
            if (prescriptionThead) {
                html = '<tr><th class="p-2 text-left align-bottom" rowspan="2">Médicament / Soin</th><th class="p-2 text-left align-bottom" rowspan="2">Posologie</th><th class="p-2 text-left align-bottom" rowspan="2">Voie</th><th class="p-2 text-left align-bottom" rowspan="2">Date de début</th>';
                for(let i=0; i<11; i++) { html += `<th class="p-2 text-center" colspan="4">Jour ${i}</th>`;}
                html += '</tr><tr>';
                for(let i=0; i<11; i++) { html += `<th class="p-1 text-center w-8">M</th><th class="p-1 text-center w-8">Mi</th><th class="p-1 text-center w-8">S</th><th class="p-1 text-center w-8">N</th>`;}
                html += '</tr>';
                prescriptionThead.innerHTML = html;
            }

            const bioThead = document.getElementById('bio-thead');
            if (bioThead) {
                html = '<tr><th class="p-2 text-left w-1/4">Analyse</th><th class="p-2 text-left w-1/4">Valeurs de référence</th>';
                for(let i=0; i<6; i++) {
                    html += `<th class="p-1"><input type="text" placeholder="JJ/MM/AA" class="font-semibold text-center w-24 bg-transparent"></th>`;
                }
                html += '</tr>';
                bioThead.innerHTML = html;
            }

            const bioTbody = document.getElementById('bio-tbody');
            if (bioTbody) {
                html = '';
                html += generateBioRows('Numération Formule Sanguine (NFS)', nfsData);
                html += generateBioRows('Bilan Électrolytique', ionoData);
                html += generateBioRows('Bilan Hépatique', hepatiqueData);
                html += generateBioRows('Bilan Lipidique', lipidiqueData);
                html += generateBioRows('Gaz du Sang (artériel)', gdsData);
                // MODIFICATION : Ajout de la ligne CRP
                html += generateBioRows('Marqueurs Inflammation', inflammationData);
                bioTbody.innerHTML = html;
            }

            const pancarteThead = document.getElementById('pancarte-thead');
            if (pancarteThead) {
                html = '<tr><th class="p-2 text-left" rowspan="2">Paramètres</th>';
                for(let i=0; i<11; i++) { html += `<th class="p-2 text-center" colspan="3">Jour ${i}</th>`;}
                html += '</tr><tr>';
                for(let i=0; i<11; i++) { html += `<th class="p-1 w-32">Matin</th><th class="p-1 w-32">Soir</th><th class="p-1 w-32">Nuit</th>`;}
                html += '</tr>';
                pancarteThead.innerHTML = html;
            }

            const pancarteTbody = document.getElementById('pancarte-tbody');
            if (pancarteTbody) {
                html = '';
                for (const param in pancarteData) {
                    html += `<tr><td class="p-2 text-left font-semibold">${param}</td>`;
                    let inputHtml = '<input type="text" value="" onchange="updatePancarteChart()">'; 
                    if (param === 'Température (°C)') {
                        inputHtml = '<input type="number" step="0.1" value="" onchange="updatePancarteChart()">';
                    }
                    for(let i=0; i<33; i++) {
                        html += `<td class="p-0">${inputHtml}</td>`;
                    }
                    html += `</tr>`;
                }
                pancarteTbody.innerHTML = html;
            }

            const careDiagramThead = document.getElementById('care-diagram-thead');
            if (careDiagramThead) {
                html = '<tr><th class="p-2 text-left">Soin / Surveillance</th>';
                for(let i=0; i<11; i++) { html += `<th colspan="3" class="border-l">Jour ${i}</th>`;}
                html += '</tr><tr><th></th>';
                for(let i=0; i<11; i++) { html += `<th class="border-l">M</th><th>S</th><th>N</th>`;}
                html += '</tr>';
                careDiagramThead.innerHTML = html;
            }
            
            const careDiagramTbody = document.getElementById('care-diagram-tbody');
            if(careDiagramTbody) {
                careDiagramTbody.innerHTML = ``;
            }
        }


        function initApp() {
            initializeDynamicTables();
            initSidebar();
            switchPatient(activePatientId, true);
            let saveTimeout;
            const debouncedSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => saveData(activePatientId), 500);
            };
            document.querySelector('main').addEventListener('input', debouncedSave);
            document.querySelector('main').addEventListener('change', debouncedSave);
            setupModalListeners();
            setupSync(); 
            document.getElementById('patient-entry-date').addEventListener('input', updateJourHosp);
            document.addEventListener('mousemove', handleIVMouseMove);
            document.addEventListener('mouseup', handleIVMouseUp);
            const activeTabId = localStorage.getItem('activeTab') || 'administratif';
            const activeTabButton = document.querySelector(`nav button[onclick*="'${activeTabId}'"]`);
            if (activeTabButton) changeTab({ currentTarget: activeTabButton }, activeTabId);
            else document.querySelector('nav[aria-label="Tabs"] button').click();

            if (!localStorage.getItem('tutorialCompleted')) {
                setTimeout(startTutorial, 500);
            }
        }
        let confirmCallback = null;
        function showDeleteConfirmation(message, callback) {
            const modal = document.getElementById('custom-confirm-modal');
            const modalBox = document.getElementById('custom-confirm-box');
            const titleEl = document.getElementById('custom-confirm-title');
            const messageEl = document.getElementById('custom-confirm-message');
            const cancelBtn = document.getElementById('custom-confirm-cancel');
            const okBtn = document.getElementById('custom-confirm-ok');

            cancelBtn.classList.remove('hidden');
            okBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
            okBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
            okBtn.textContent = 'Confirmer';

            titleEl.textContent = 'Confirmation requise';
            messageEl.textContent = message;

            confirmCallback = callback;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        function hideConfirmation() {
            const modal = document.getElementById('custom-confirm-modal');
            const modalBox = document.getElementById('custom-confirm-box');
            
            modalBox.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                
                confirmCallback = null;
            }, 200);
        }
        function setupModalListeners() {
            document.getElementById('custom-confirm-ok').addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                hideConfirmation();
            });
            document.getElementById('custom-confirm-cancel').addEventListener('click', hideConfirmation);
        }

        function showCustomAlert(title, message) {
            const modal = document.getElementById('custom-confirm-modal');
            const modalBox = document.getElementById('custom-confirm-box');
            const titleEl = document.getElementById('custom-confirm-title');
            const messageEl = document.getElementById('custom-confirm-message');
            const cancelBtn = document.getElementById('custom-confirm-cancel');
            const okBtn = document.getElementById('custom-confirm-ok');

            cancelBtn.classList.add('hidden');
            okBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
            okBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
            okBtn.textContent = 'Fermer';

            titleEl.textContent = title;
            messageEl.textContent = message;

            confirmCallback = null;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function updateJourHosp() {
            const entryDateEl = document.getElementById('patient-entry-date');
            const jourHospEl = document.getElementById('patient-jour-hosp');
            if (!entryDateEl.value) {
                jourHospEl.textContent = 'J-';
                return;
            }
            const entryDate = new Date(entryDateEl.value);
            if (isNaN(entryDate.getTime())) {
                jourHospEl.textContent = 'J-';
                return;
            }
            const today = new Date();
            entryDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffTime = today - entryDate;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            jourHospEl.textContent = `J${diffDays}`;
        }
        function setupSync() {
            const syncMap = [
                ['patient-nom-usage', 'admin-nom-usage'],
                ['patient-prenom', 'admin-prenom'],
                ['patient-dob', 'admin-dob']
            ];
            syncMap.forEach(([id1, id2]) => {
                const el1 = document.getElementById(id1);
                const el2 = document.getElementById(id2);
                if (el1 && el2) {
                    el1.addEventListener('input', () => {
                        if (!el2.disabled) {
                            el2.value = el1.value;
                            if (el2.tagName.toLowerCase() === 'textarea') autoResize(el2);
                            if(id1.includes('dob')) updateAgeDisplay();
                        }
                    });
                    el2.addEventListener('input', () => {
                        if (!el1.disabled) {
                            el1.value = el1.value;
                            if (el1.tagName.toLowerCase() === 'textarea') autoResize(el1);
                            if(id2.includes('dob')) updateAgeDisplay();
                        }
                    });
                }
            });
        }
        function calculateAge(dobString) {
            if (!dobString) return '';
            const dob = new Date(dobString);
            const today = new Date();
            if (isNaN(dob.getTime()) || dob > today) return '';
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            return age >= 0 ? `${age} ans` : '';
        }
        function updateAgeDisplay() {
            const dobHeader = document.getElementById('patient-dob').value;
            document.getElementById('patient-age').textContent = calculateAge(dobHeader);
            const dobAdmin = document.getElementById('admin-dob').value;
            document.getElementById('admin-age').textContent = calculateAge(dobAdmin);
        }
        function deleteEntry(button) {
            const entry = button.closest('.timeline-item');
            if (entry) {
                showDeleteConfirmation("Êtes-vous sûr de vouloir supprimer cette entrée ?", () => {
                    entry.remove();
                    saveData(activePatientId);
                });
            }
        }
        function deletePrescription(button) {
            const row = button.closest('tr');
            if (row) {
                showDeleteConfirmation("Êtes-vous sûr de vouloir supprimer cette prescription ?", () => {
                    row.remove();
                    saveData(activePatientId);
                });
            }
        }

        function deleteCareDiagramRow(button) {
            const row = button.closest('tr');
            if (row) {
                showDeleteConfirmation("Êtes-vous sûr de vouloir supprimer ce soin du diagramme ?", () => {
                    row.remove();
                    saveData(activePatientId);
                });
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        function toggleFullscreen() {
            const elem = document.documentElement;
            const icon = document.getElementById('fullscreen-icon');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => console.log(err.message));
                icon.classList.replace('fa-expand', 'fa-compress');
            } else {
                document.exitFullscreen();
                icon.classList.replace('fa-compress', 'fa-expand');
            }
        }
        function updateDynamicDates(startDate) {
            const updateHeaders = (selector) => {
                document.querySelectorAll(selector).forEach((th, index) => {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + index);
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    th.innerHTML = `Jour ${index}<br><span class="text-xs font-normal">${day}/${month}</span>`;
                });
            };
            updateHeaders('#prescription-table thead tr:first-child th[colspan="4"]');
            updateHeaders('#pancarte-table thead tr:first-child th[colspan="3"]');
            updateHeaders('#care-diagram-table thead tr:first-child th[colspan="3"]');
            if (pancarteChartInstance) updatePancarteChart();
        }
        function toggleLock(containerId, buttonId) {
            const container = document.getElementById(containerId);
            const button = document.getElementById(buttonId);
            const inputs = container.querySelectorAll('.info-value, input[type=text], input[type=date]');
            const isUnlocking = button.innerHTML.includes('fa-lock');
            if (!isUnlocking && containerId === 'patient-header-form') {
                const entryDateValue = document.getElementById('patient-entry-date').value;
                if (entryDateValue) {
                    const entryDate = new Date(entryDateValue);
                    if (!isNaN(entryDate.getTime())) {
                        updateDynamicDates(entryDate);
                        updateJourHosp();
                    }
                }
            }
            inputs.forEach(input => {
                input.disabled = !isUnlocking;
                if (input.tagName.toLowerCase() === 'textarea' && isUnlocking) autoResize(input);
            });
            const colorMap = {
                'lock-header-btn': { unlocked: ['border-teal-600', 'text-teal-700', 'hover:bg-teal-600'], locked: ['border-gray-400', 'text-gray-500', 'hover:bg-gray-400'] },
                'lock-admin-btn': { unlocked: ['border-teal-600', 'text-teal-700', 'hover:bg-teal-600'], locked: ['border-gray-400', 'text-gray-500', 'hover:bg-gray-400'] },
                'lock-vie-btn': { unlocked: ['border-blue-600', 'text-blue-700', 'hover:bg-blue-600'], locked: ['border-gray-400', 'text-gray-500', 'hover:bg-gray-400'] }
            };
            const styles = colorMap[buttonId];
            const baseUnlockedText = (buttonId === 'lock-header-btn') ? "Valider" : "Valider les données";
            if (isUnlocking) {
                button.innerHTML = `<i class="fas fa-check mr-2"></i> ${baseUnlockedText}`;
                button.classList.remove(...styles.locked); button.classList.add(...styles.unlocked);
            } else {
                button.innerHTML = `<i class="fas fa-lock mr-2"></i> Lock`;
                button.classList.remove(...styles.unlocked); button.classList.add(...styles.locked);
            }
        }
        function changeTab(event, tabId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(tabId);
            activeSection.classList.add('active');
            const baseClasses = "min-h-[4rem] py-2 px-2 text-sm font-medium rounded-lg border focus:outline-none transition-all ease-in-out duration-300 flex-1 flex items-center justify-center text-center";
            const inactiveClasses = "text-gray-600 bg-white border-gray-200 hover:bg-gray-100";
            const activeClasses = { blue: "text-blue-900 border-blue-300 bg-gradient-to-br from-blue-200 to-cyan-200 shadow-inner", teal: "text-teal-900 border-teal-300 bg-gradient-to-br from-teal-200 to-green-200 shadow-inner", rose: "text-rose-900 border-rose-300 bg-gradient-to-br from-rose-200 to-pink-200 shadow-inner", indigo: "text-indigo-900 border-indigo-300 bg-gradient-to-br from-indigo-200 to-violet-200 shadow-inner", green: "text-green-900 border-green-300 bg-gradient-to-br from-green-200 to-lime-200 shadow-inner", purple: "text-purple-900 border-purple-300 bg-gradient-to-br from-purple-200 to-pink-200 shadow-inner", orange: "text-orange-900 border-orange-300 bg-gradient-to-br from-amber-200 to-orange-200 shadow-inner"};
            document.querySelectorAll('nav[aria-label="Tabs"] button').forEach(tab => tab.className = `${baseClasses} ${inactiveClasses}`);
            const clickedTab = event.currentTarget;
            const color = clickedTab.dataset.color;
            clickedTab.className = `${baseClasses} ${activeClasses[color]}`;
            document.querySelectorAll('.card-header').forEach(h => Object.keys(activeClasses).forEach(c => h.classList.remove(`header-${c}`)));
            document.getElementById(tabId).querySelectorAll('.card-header').forEach(h => h.classList.add(`header-${color}`));
            localStorage.setItem('activeTab', tabId);
            setTimeout(() => {
                activeSection.querySelectorAll('textarea.info-value').forEach(autoResize);
            }, 0);
            if (tabId === 'pancarte') setTimeout(() => updatePancarteChart(), 50);
        }
        function addObservation() {
            const author = document.getElementById('new-observation-author').value.trim();
            const text = document.getElementById('new-observation-text').value.trim();
            const dateValue = document.getElementById('new-observation-date').value;
            if (!text || !author) return;
            const eventDate = dateValue ? new Date(dateValue) : new Date();
            const formattedDate = new Date(eventDate.getTime() - (eventDate.getTimezoneOffset() * 60000)).toLocaleDateString('fr-FR');
            const newHTML = `<div class="timeline-item"><div class="timeline-dot dot-rose"></div><div class="flex justify-between items-start"><h3 class="font-semibold text-gray-800">${formattedDate} - ${author.toUpperCase()}</h3><button type="button" onclick="deleteEntry(this)" class="ml-2 text-red-500 hover:text-red-700 transition-colors" title="Supprimer l'observation"><i class="fas fa-times-circle"></i></button></div><p class="text-gray-600 preserve-whitespace">${text}</p></div>`;
            document.getElementById('observations-list').insertAdjacentHTML('afterbegin', newHTML);
            document.getElementById('new-observation-form').reset();
        }
        function addTransmission() {
            const author = document.getElementById('new-transmission-author-2').value.trim();
            const text = document.getElementById('new-transmission-text-2').value.trim();
            const dateValue = document.getElementById('new-transmission-date').value;
            if (!text || !author) return;
            const eventDate = dateValue ? new Date(dateValue) : new Date();
            const formattedDate = new Date(eventDate.getTime() - (eventDate.getTimezoneOffset() * 60000)).toLocaleDateString('fr-FR');
            const formattedText = text.replace(/Cible :/g, '<strong class="text-gray-900">Cible :</strong>').replace(/Données :/g, '<br><strong class="text-gray-900">Données :</strong>').replace(/Actions :/g, '<br><strong class="text-gray-900">Actions :</strong>').replace(/Résultat :/g, '<br><strong class="text-gray-900">Résultat :</strong>');
            const newHTML = `<div class="timeline-item"><div class="timeline-dot dot-green"></div><div class="flex justify-between items-start"><h3 class="font-semibold text-gray-800">${formattedDate} - ${author.toUpperCase()}</h3><button type="button" onclick="deleteEntry(this)" class="ml-2 text-red-500 hover:text-red-700 transition-colors" title="Supprimer la transmission"><i class="fas fa-times-circle"></i></button></div><p class="text-gray-600 preserve-whitespace">${formattedText}</p></div>`;
            document.getElementById('transmissions-list-ide').insertAdjacentHTML('afterbegin', newHTML);
            document.getElementById('new-transmission-form-2').reset();
        }
        function addPrescription(data = null, fromLoad = false) {
            let name, posologie, voie, startDate, type, checkboxes, bars;
            if (fromLoad) {
                ({ name, posologie, voie, startDate, type, checkboxes, bars } = data);
            } else {
                name = document.getElementById('med-name').value.trim();
                posologie = document.getElementById('med-posologie').value.trim();
                voie = document.getElementById('med-voie').value.trim();
                const startDateValue = document.getElementById('med-start-date').value;
                if (!name || !startDateValue) return;
                const [year, month, day] = startDateValue.split('-');
                startDate = `${day}/${month}/${year.slice(2)}`;
                type = voie.trim().toUpperCase() === 'IV' ? 'iv' : 'checkbox';
            }
            const tbody = document.getElementById("prescription-tbody");
            const newRow = tbody.insertRow();
            newRow.dataset.type = type;
            const baseCellsHTML = `
                <td class="p-2 text-left align-top">
                    <div class="flex items-start justify-between">
                        <span>${name}</span>
                        <button type="button" onclick="deletePrescription(this)" class="ml-2 text-red-500 hover:text-red-700 transition-colors" title="Supprimer la prescription">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                </td>
                <td class="p-2 text-left align-top">${posologie}</td>
                <td class="p-2 text-left align-top">${voie}</td>
                <td class="p-2 text-left align-top">${startDate}</td>
            `;
            if (type === 'iv') {
                newRow.innerHTML = baseCellsHTML;
                const timelineCell = newRow.insertCell();
                timelineCell.colSpan = 44;
                timelineCell.className = 'iv-bar-container';
                timelineCell.addEventListener('mousedown', handleIVMouseDown);
                const barsToCreate = [];
                if (fromLoad && bars && Array.isArray(bars)) {
                    barsToCreate.push(...bars);
                } else if (fromLoad && data.left && data.width) { 
                    barsToCreate.push({ left: data.left, width: data.width, title: data.title });
                }
                barsToCreate.forEach(barData => {
                    if (barData && barData.left && barData.width) {
                        const bar = document.createElement('div');
                        bar.className = 'iv-bar';
                        bar.style.left = barData.left;
                        bar.style.width = barData.width;
                        bar.title = barData.title || '';
                        bar.addEventListener('dblclick', handleIVDblClick);
                        const handle = document.createElement('div');
                        handle.className = 'resize-handle';
                        bar.appendChild(handle);
                        timelineCell.appendChild(bar);
                        setTimeout(() => updateIVBarDetails(bar, timelineCell), 0);
                    }
                });
            } else {
                let checkboxCellsHTML = '';
                for (let i = 0; i < 11; i++) {
                    for (let j = 0; j < 4; j++) {
                        const cbIndex = i * 4 + j;
                        const isChecked = fromLoad && checkboxes && checkboxes[cbIndex];
                        checkboxCellsHTML += `<td class="p-0"><input type="checkbox" ${isChecked ? 'checked' : ''}></td>`;
                    }
                }
                newRow.innerHTML = baseCellsHTML + checkboxCellsHTML;
            }
            if (!fromLoad) {
                document.getElementById('new-prescription-form').reset();
            }
        }
        function addCareDiagramRow() {
            const name = document.getElementById('care-name').value.trim();
            if (!name) return;
            const newRow = document.getElementById('care-diagram-tbody').insertRow();
            
            let cellsHTML = `
                <td class="p-2 text-left align-top">
                    <div class="flex items-start justify-between">
                        <span>${name}</span>
                        <button type="button" onclick="deleteCareDiagramRow(this)" class="ml-2 text-red-500 hover:text-red-700 transition-colors" title="Supprimer ce soin">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                </td>
            `;
            
            for(let i=0; i<11; i++) cellsHTML += `<td class="border-l"><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>`;
            newRow.innerHTML = cellsHTML;
            document.getElementById('new-care-form').reset();
        }
        function handleIVDblClick(e) {
            const bar = e.currentTarget;
            showDeleteConfirmation("Effacer cette barre de perfusion IV ?", () => {
                const cell = bar.parentElement;
                if(cell) {
                    cell.querySelectorAll('.iv-time-label').forEach(label => label.remove());
                }
                bar.remove();
                saveData(activePatientId);
            });
        }
        function handleIVMouseDown(e) {
            if (e.target.classList.contains('iv-bar-container')) {
                ivInteraction.mode = 'draw';
                const cell = e.target;
                const rect = cell.getBoundingClientRect();
                const startX = e.clientX - rect.left;
                const newBar = document.createElement('div');
                newBar.className = 'iv-bar';
                newBar.style.left = `${(startX / rect.width) * 100}%`;
                newBar.style.width = '0px';
                newBar.addEventListener('dblclick', handleIVDblClick);
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                newBar.appendChild(handle);
                cell.appendChild(newBar);
                ivInteraction = {
                    ...ivInteraction,
                    active: true,
                    targetBar: newBar,
                    targetCell: cell,
                    startX: e.clientX,
                };
                document.body.classList.add('is-drawing-iv');
            } else if (e.target.classList.contains('resize-handle')) {
                ivInteraction.mode = 'resize';
                const bar = e.target.parentElement;
                const cell = bar.parentElement;
                ivInteraction = {
                    ...ivInteraction,
                    active: true,
                    targetBar: bar,
                    targetCell: cell,
                    startX: e.clientX,
                    startWidth: bar.offsetWidth,
                };
                document.body.classList.add('is-resizing-iv');
            } else if (e.target.classList.contains('iv-bar')) {
                ivInteraction.mode = 'move';
                const bar = e.target;
                const cell = bar.parentElement;
                 ivInteraction = {
                    ...ivInteraction,
                    active: true,
                    targetBar: bar,
                    targetCell: cell,
                    startX: e.clientX,
                    startLeft: bar.offsetLeft,
                };
                document.body.classList.add('is-moving-iv');
            }
        }
        function handleIVMouseMove(e) {
            if (!ivInteraction.active) return;
            e.preventDefault();
            const { mode, targetBar, targetCell, startX, startWidth, startLeft } = ivInteraction;
            const cellRect = targetCell.getBoundingClientRect();
            const dx = e.clientX - startX;
            if (mode === 'draw' || mode === 'resize') {
                let newWidth = startWidth + dx;
                newWidth = Math.max(5, newWidth); 
                newWidth = Math.min(newWidth, cellRect.width - targetBar.offsetLeft);
                targetBar.style.width = `${(newWidth / cellRect.width) * 100}%`;
            } else if (mode === 'move') {
                let newLeft = startLeft + dx;
                newLeft = Math.max(0, newLeft);
                newLeft = Math.min(newLeft, cellRect.width - targetBar.offsetWidth);
                 targetBar.style.left = `${(newLeft / cellRect.width) * 100}%`;
            }
            updateIVBarDetails(targetBar, targetCell);
        }
        function handleIVMouseUp(e) {
            if (!ivInteraction.active) return;
            document.body.className = document.body.className.replace(/is-(drawing|resizing|moving)-iv/g, '').trim().trim();
            ivInteraction = { active: false, mode: null, targetBar: null, targetCell: null, startX: 0, startLeft: 0, startWidth: 0 };
            saveData(activePatientId);
        }
        function updateIVBarDetails(bar, cell) {
            if (!bar || !cell) return;
            const tableStartDateStr = document.getElementById('patient-entry-date').value;
            if (!tableStartDateStr) return;
            const tableStartDate = new Date(tableStartDateStr);
            const totalTimelineMillis = 11 * 24 * 60 * 60 * 1000;
            const startPercent = parseFloat(bar.style.left);
            const widthPercent = parseFloat(bar.style.width);
            const endPercent = startPercent + widthPercent;
            const startOffsetMillis = (startPercent / 100) * totalTimelineMillis;
            const durationMillis = (widthPercent / 100) * totalTimelineMillis;
            const startDateTime = new Date(tableStartDate.getTime() + startOffsetMillis);
            const endDateTime = new Date(startDateTime.getTime() + durationMillis);
            const formatTime = (date) => date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }).replace(':', 'h');
            bar.title = `Début: ${startDateTime.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short'})}\nFin: ${endDateTime.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short'})}`;
            let startLabel = cell.querySelector('.iv-time-label.start');
            if (!startLabel) {
                startLabel = document.createElement('span');
                startLabel.className = 'iv-time-label start';
                cell.appendChild(startLabel);
            }
            let endLabel = cell.querySelector('.iv-time-label.end');
            if (!endLabel) {
                endLabel = document.createElement('span');
                endLabel.className = 'iv-time-label end';
                cell.appendChild(endLabel);
            }
            startLabel.textContent = formatTime(startDateTime);
            startLabel.style.left = `${startPercent}%`;
            endLabel.textContent = formatTime(endDateTime);
            endLabel.style.left = `${endPercent}%`;
        }
        function updatePancarteChart() {
            const table = document.getElementById('pancarte-table');
            const entryDateVal = document.getElementById('patient-entry-date').value;
            const startDate = entryDateVal ? new Date(entryDateVal) : new Date();
            const labels = Array.from({ length: 33 }).map((_, i) => {
                const dayOffset = Math.floor(i / 3);
                const timeOfDay = ['Matin', 'Soir', 'Nuit'][i % 3];
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + dayOffset);
                return `${currentDate.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'})} ${timeOfDay}`;
            });
            const dataSetsConfig = { 'Pouls (/min)': { yAxisID: 'y1', borderColor: '#ef4444' }, 'Tension (mmHg)': { type: 'bar', yAxisID: 'y', backgroundColor: '#f9731640' }, 'Température (°C)': { yAxisID: 'y3', borderColor: '#3b82f6' }, 'SpO2 (%)': { yAxisID: 'y4', borderColor: '#10b981' }, 'Douleur (EVA /10)': { yAxisID: 'y2', borderColor: '#8b5cf6' }};
            const datasets = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                const paramName = row.cells[0].textContent.trim();
                let data = Array.from(row.querySelectorAll('input')).map(input => {
                    if (paramName === 'Tension (mmHg)' && input.value.includes('/')) {
                        const parts = input.value.split('/');
                        return [parseFloat(parts[1]), parseFloat(parts[0])];
                    }
                    const value = parseFloat(input.value.replace(',', '.'));
                    return isNaN(value) ? null : value;
                }); 
                return { label: paramName, data, type: 'line', tension: 0.2, borderWidth: 2, spanGaps: true, pointBackgroundColor: dataSetsConfig[paramName].borderColor, ...dataSetsConfig[paramName] };
            });
            const ctx = document.getElementById('pancarteChart').getContext('2d');
            if (pancarteChartInstance) pancarteChartInstance.destroy();
            pancarteChartInstance = new Chart(ctx, {
                type: 'bar', data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'Tension (mmHg)' }, min: 0, max: 200 },
                        y1: { position: 'right', title: { display: true, text: 'Pouls' }, grid: { drawOnChartArea: false }, min: 0, max: 200 },
                        y2: { position: 'right', title: { display: true, text: 'Douleur' }, grid: { drawOnChartArea: false }, max: 10, min: 0 },
                        y3: { position: 'right', title: { display: true, text: 'Température' }, grid: { drawOnChartArea: false }, min: 36, max: 41, ticks: { stepSize: 0.5 } },
                        y4: { position: 'right', title: { display: true, text: 'SpO2' }, grid: { drawOnChartArea: false }, min: 50, max: 100 }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: ctx => ctx.dataset.label === 'Tension (mmHg)' && ctx.raw?.length === 2 ? `${ctx.dataset.label}: ${ctx.raw[1]}/${ctx.raw[0]}` : `${ctx.dataset.label}: ${ctx.formattedValue}` }}
                    }
                }
            });
        }

        const tutorialSteps = [
            {
                element: '#patient-list li:first-child button',
                text: "Bienvenue ! Voici la liste des patients. Cliquez sur un patient pour ouvrir son dossier. (Vous pouvez remplir le dossier pour voir un nom ici).",
                position: 'right'
            },
            {
                element: '#patient-header-form',
                text: "Cet en-tête contient les informations principales du patient. Remplissez-le et cliquez sur 'Valider' pour verrouiller les champs et définir la date d'entrée.",
                position: 'bottom'
            },
            {
                element: '#tabs-nav-container',
                text: "Utilisez ces onglets pour naviguer entre les différentes sections du dossier : Administratif, Prescriptions, Transmissions, etc.",
                position: 'bottom'
            },
            {
                element: '#header-buttons button[title*="Exporter"]',
                text: "Ce bouton vous permet d'exporter le dossier du patient actuel au format JSON, pour le sauvegarder ou le partager.",
                position: 'bottom-left'
            },
            {
                element: '#header-buttons button[title*="Importer"]',
                text: "Utilisez ce bouton pour importer un fichier JSON et charger les données d'un patient dans ce dossier.",
                position: 'bottom-left'
            },
            {
                element: '#header-buttons button[title*="Effacer"]',
                text: "Attention : Ce bouton efface toutes les données du patient actuellement sélectionné.",
                position: 'bottom-left'
            },
            {
                element: 'button[onclick="clearAllData()"]',
                text: "ATTENTION : Ce bouton supprime DÉFINITIVEMENT tous les dossiers de tous les patients. À n'utiliser que pour réinitialiser la simulation.",
                position: 'top'
            },
            {
                element: 'button[onclick="startTutorial()"]',
                text: "Vous avez terminé ! Vous pouvez relancer ce tutoriel à tout moment en cliquant sur ce bouton.",
                position: 'top'
            }
        ];

        let currentStepIndex = 0;
        let highlightedElement = null;

        function startTutorial() {
            currentStepIndex = 0;
            document.getElementById('tutorial-overlay').classList.remove('hidden');
            showTutorialStep(currentStepIndex);
        }

        function endTutorial(setFlag = false) {
            document.getElementById('tutorial-overlay').classList.add('hidden');
            if (highlightedElement) {
                highlightedElement.classList.remove('tutorial-highlight');
                if (highlightedElement.closest('#header-buttons')) {
                    highlightedElement.style = '';
                }
                highlightedElement = null;
            }
            if (setFlag) {
                localStorage.setItem('tutorialCompleted', 'true');
            }
        }

        function showTutorialStep(index) {
            if (highlightedElement) {
                highlightedElement.classList.remove('tutorial-highlight');
                if (highlightedElement.closest('#header-buttons')) {
                    highlightedElement.style = '';
                }
            }

            if (index >= tutorialSteps.length) {
                endTutorial(true);
                return;
            }

            const step = tutorialSteps[index];
            const element = document.querySelector(step.element);
            const stepBox = document.getElementById('tutorial-step-box');
            const stepText = document.getElementById('tutorial-text');
            const nextButton = document.getElementById('tutorial-next-btn');

            if (!element) {
                if (index === 0) {
                     tutorialSteps[0].element = '#sidebar';
                     tutorialSteps[0].text = "Bienvenue ! Voici la barre latérale où les patients apparaîtront. Pour l'instant, elle est vide. Vous pouvez commencer par remplir les dossiers.";
                     showTutorialStep(index);
                } else {
                    currentStepIndex++;
                    showTutorialStep(currentStepIndex);
                }
                return;
            }

            stepText.textContent = step.text;

            if (index === tutorialSteps.length - 1) {
                nextButton.textContent = "Terminer";
            } else {
                nextButton.textContent = "Suivant";
            }
            
            element.classList.add('tutorial-highlight');
            highlightedElement = element;

            if (element.closest('#header-buttons')) {
                element.style.setProperty('z-index', '9997', 'important');
                element.style.setProperty('position', 'relative', 'important');
            }


            const rect = element.getBoundingClientRect();
            const boxRect = stepBox.getBoundingClientRect();
            const margin = 15;

            let top = rect.bottom + margin;
            let left = rect.left + (rect.width / 2) - (boxRect.width / 2);

            if (step.position === 'right') {
                top = rect.top + (rect.height / 2) - (boxRect.height / 2);
                left = rect.right + margin;
            } else if (step.position === 'left') {
                top = rect.top + (rect.height / 2) - (boxRect.height / 2);
                left = rect.left - boxRect.width - margin;
            } else if (step.position === 'top') {
                top = rect.top - boxRect.height - margin;
                left = rect.left + (rect.width / 2) - (boxRect.width / 2);
            } else if (step.position === 'bottom-left') {
                 top = rect.bottom + margin;
                 left = rect.right - boxRect.width;
            }

            if (top < margin) top = margin;
            if (left < margin) left = margin;
            if (top + boxRect.height > window.innerHeight - margin) {
                top = window.innerHeight - boxRect.height - margin;
                if (step.position === 'top') top = rect.bottom + margin;
            }
            if (left + boxRect.width > window.innerWidth - margin) {
                left = window.innerWidth - boxRect.width - margin;
            }


            stepBox.style.top = `${top}px`;
            stepBox.style.left = `${left}px`;
        }

        document.getElementById('tutorial-next-btn').addEventListener('click', () => {
            currentStepIndex++;
            showTutorialStep(currentStepIndex);
        });


        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KKWCL3F2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    
</html>
